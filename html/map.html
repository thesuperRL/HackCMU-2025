<!DOCTYPE html>
<html>

<head>
  <title>leaflet-map-csv (clustered)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- MarkerCluster plugin -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- jQuery + PapaParse -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; right: 0; left: 0; }

    /* Custom cluster sizes for readability */
    .marker-cluster-small {
      background: rgba(97, 175, 254, 0.6);
      border: 2px solid rgba(97, 175, 254, 0.9);
    }
    .marker-cluster-small div {
      width: 30px; height: 30px; line-height: 30px;
      border-radius: 50%;
      text-align: center; font-weight: 700; color: #fff;
    }

    .marker-cluster-medium {
      background: rgba(255, 165, 0, 0.6);
      border: 2px solid rgba(255, 165, 0, 0.9);
    }
    .marker-cluster-medium div {
      width: 44px; height: 44px; line-height: 44px;
      border-radius: 50%;
      text-align: center; font-weight: 700; color: #fff;
      font-size: 14px;
    }

    .marker-cluster-large {
      background: rgba(220, 53, 69, 0.6);
      border: 2px solid rgba(220, 53, 69, 0.9);
    }
    .marker-cluster-large div {
      width: 60px; height: 60px; line-height: 60px;
      border-radius: 50%;
      text-align: center; font-weight: 800; color: #fff;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // Set up initial map
    var map = L.map('map', {
      center: [40.44, -79.94],
      zoom: 9,
      scrollWheelZoom: true,
      tap: false
    });

    // Basemap
    var light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    // Cluster group with tiered icon sizes
    // - small: < 50 points
    // - medium: 50â€“199 points
    // - large: 200+ points
    var clusters = L.markerClusterGroup({
      maxClusterRadius: 60,           // how close points must be to cluster (px)
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      disableClusteringAtZoom: 18,
      iconCreateFunction: function (cluster) {
        var count = cluster.getChildCount();
        var sizeClass = 'small';
        if (count >= 50 && count < 200) sizeClass = 'medium';
        else if (count >= 200) sizeClass = 'large';

        // Log cluster info for debugging
        console.log('Cluster created:', { count, sizeClass });

        // Create a DivIcon with our custom class
        return new L.DivIcon({
          html: '<div><span>' + count + '</span></div>',
          className: 'marker-cluster marker-cluster-' + sizeClass,
          iconSize: L.point(
            sizeClass === 'large' ? 60 : sizeClass === 'medium' ? 44 : 30,
            sizeClass === 'large' ? 60 : sizeClass === 'medium' ? 44 : 30
          )
        });
      }
    });

    // Read markers data from CSV
    $.get('../data/lanternflydata.csv', function (csvString) {
      console.log("got data");
      var data = Papa.parse(csvString, { header: true, dynamicTyping: true }).data;

      for (var i in data) {
        var row = data[i];

        // Debugging: print the entire row object
        console.log("Row " + i + ":", row);

        // Skip empty rows (PapaParse sometimes adds an extra)
        if (!row || !row.Latitude || !row.Longitude) {
          console.log("Skipping row", i, "because of missing coordinates");
          continue;
        }

        // Build popup content (keep your logging)
        var popupContent = `<b>${row.Name || 'Sighting'}</b><br>`;
        if (row.Date) popupContent += `<i>${row.Date}</i><br>`;
        if (row.Image) popupContent += `<img src="${row.Image}" alt="${row.Name}" width="120" />`;
        console.log("Popup content for row " + i + ":", popupContent);

        // Create marker
        var marker = L.marker([row.Latitude, row.Longitude], { opacity: 1 }).bindPopup(popupContent);

        // Add to cluster group (NOT directly to map)
        clusters.addLayer(marker);
      }

      // Add cluster layer to map once all markers are added
      map.addLayer(clusters);

      // Fit to bounds of all points if we have any
      if (clusters.getLayers().length > 0) {
        var bounds = clusters.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.1));
        }
      }
    });
  </script>
</body>

</html>
