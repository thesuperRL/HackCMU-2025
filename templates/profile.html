<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profile · LanternFly Quest</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../static/css/style.css" />
  <style>
    .auth { display:flex; align-items:center; gap:.5rem; }
    .profile { position: relative; margin-left: .25rem; }
    .icon-btn{ display:inline-flex;align-items:center;justify-content:center; width:38px;height:38px;border-radius:999px; border:1px solid rgba(148,163,184,.22); background: var(--bg-elev,#0f152a); color: var(--fg,#eef2ff); cursor:pointer; }
    .icon-btn img{ width:100%; height:100%; border-radius:999px; object-fit:cover; display:block; }
    .dropdown { position:absolute; right:0; top:calc(100% + 8px); z-index:1000; min-width:260px; background: var(--bg-elev,#0f152a); color: var(--fg,#eef2ff); border:1px solid rgba(148,163,184,.18); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03); padding:8px; }
    .dropdown.hidden { display:none; }
    .dropdown-header{ padding:8px 10px 10px; border-bottom:1px solid rgba(148,163,184,.18); margin-bottom:8px; font-weight:700; }
    .dropdown-header small{ color: var(--muted,#9aa4c7); font-weight:600; }
    .dropdown-item{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; color:inherit; text-decoration:none; cursor:pointer; }
    .dropdown-item:hover{ background: rgba(255,255,255,.06); }
    .dropdown-item.btn-danger{ color:#fff; background: linear-gradient(180deg, var(--danger,#f87171), #b91c1c); }
    .rule { height:1px; background: rgba(148,163,184,.18); margin:8px 0; }

    .pf-hero { padding: 48px 0 16px; border-bottom:1px solid rgba(255,255,255,.06); }
    .pf-card { display:grid; grid-template-columns: 84px 1fr auto; gap:12px; align-items:center; padding:16px; border:1px solid rgba(255,255,255,.08); border-radius:16px; background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02)); }
    .pf-avatar { width:84px; height:84px; border-radius:999px; overflow:hidden; background: rgba(255,255,255,.06); display:grid; place-items:center; }
    .pf-avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .pf-meta { color: var(--muted); }
    .pf-stats { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top:16px; }
    .pf-stat { padding:14px; border:1px solid rgba(255,255,255,.08); border-radius:16px; background: var(--bg-elev,#0f152a); display:grid; gap:6px; }
    .pf-stat .v { font-size:1.3rem; font-weight:800; }
    .pf-list li { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.08); }
    .pf-list li:last-child{ border-bottom:none; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/" aria-label="Home">
        <svg class="logo" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c-2.5 0-4.5 2-4.5 4.5S12 14 12 14s4.5-5 4.5-7.5S14.5 2 12 2zm0 0c-3 0-5.5 2.5-5.5 5.5S9 13 12 13s5.5-2.5 5.5-5.5S15 2 12 2z" fill="currentColor"/></svg>
        <span class="title">LanternFly Quest</span>
        <span class="pill">alpha</span>
      </a>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/info">About</a>
        <a href="/learn">Learn</a>
        <a href="/report">Report</a>
        <a href="/leaderboard">Leaderboard</a>
      </nav>
      <div class="auth">
        <div class="profile">
          <button id="profileBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" title="Account"><i class="bi bi-person-circle" aria-hidden="true"></i></button>
          <div id="profileMenu" class="dropdown hidden" role="menu" aria-label="Account menu">
            <div class="dropdown-header">
              <div id="ddName">Guest</div>
              <small id="ddEmail">Not signed in</small>
            </div>
            <div id="gisBlock" class="dropdown-item" style="justify-content:center;"><div id="gisBtn"></div></div>
            <div class="rule"></div>
            <a class="dropdown-item" href="/profile"><i class="bi bi-person"></i> Profile</a>
            <a class="dropdown-item" href="/achievements"><i class="bi bi-award"></i> Achievements</a>
            <div class="rule"></div>
            <button id="logoutMenuBtn" class="dropdown-item btn-danger" type="button"><i class="bi bi-box-arrow-right"></i> Log out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="pf-hero">
    <div class="container">
      <div class="pf-card">
        <div class="pf-avatar"><img id="pfAvatar" alt="Avatar" /></div>
        <div>
          <h1 id="pfName" style="margin:0 0 4px 0;">Guest</h1>
          <div class="pf-meta"><span id="pfEmail">Not signed in</span> • Active since <span id="pfSince">—</span></div>
        </div>
        <div>
          <a class="btn" href="/report"><i class="bi bi-plus-circle"></i> Log a Catch</a>
        </div>
      </div>

      <div class="pf-stats">
        <div class="pf-stat">
          <div class="v" id="pfTotal">0</div>
          <div class="k">Total flies caught</div>
        </div>
        <div class="pf-stat">
          <div class="v" id="pfLocations">0</div>
          <div class="k">Distinct locations</div>
        </div>
        <div class="pf-stat">
          <div class="v" id="pfDays">0</div>
          <div class="k">Days active</div>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h3 style="margin:0 0 8px 0"><i class="bi bi-geo"></i> Recent catches</h3>
        <ul id="pfList" class="pf-list" aria-live="polite"></ul>
      </div>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container footer-inner">
      <span>LanternFly Quest · v0.1</span>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async></script>
  <script src="{{ url_for('static', filename='js/main.js') }}?v=3"></script>
  <div id="g_id_onload" data-auto_prompt="false" data-client_id="598997653463-svi76fvbe15v910t9c91eulju4vqasaa.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>

  <script>
    function getLocalUser(){
      try {
        return JSON.parse(localStorage.getItem('lfq.user')) || JSON.parse(localStorage.getItem('LFQ_USER')) || null;
      } catch { return null; }
    }
    function fmtDate(d){
      try {
        const dt = new Date(d);
        if (!isNaN(dt.valueOf())) return dt.toLocaleDateString();
        const s = (d==null? '': String(d).trim());
        return s || '—';
      } catch { return (d==null? '—' : String(d)); }
    }
    function dayDiff(a,b){ try{ return Math.max(0, Math.round((new Date(b)-new Date(a))/(1000*60*60*24))); }catch{ return 0; } }

    async function loadAllLocations(){
      try{
        const res = await fetch('/locations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'request'}) });
        if(res.ok){ return await res.json(); }
      }catch(e){ /* ignore; will fallback to none */ }
      return [];
    }

    (async function init(){
      const u = getLocalUser();
      const avatar = document.getElementById('pfAvatar');
      const nameEl = document.getElementById('pfName');
      const emailEl = document.getElementById('pfEmail');
      const sinceEl = document.getElementById('pfSince');
      const listEl = document.getElementById('pfList');
      const totalEl = document.getElementById('pfTotal');
      const locsEl = document.getElementById('pfLocations');
      const daysEl = document.getElementById('pfDays');

      if (u){
        nameEl.textContent = u.name || 'User';
        emailEl.textContent = u.email || '';
        if (u.picture) { avatar.src = u.picture; } else { avatar.src = 'https://ui-avatars.com/api/?name='+(encodeURIComponent(u.name||'U'))+'&size=128&background=0D8ABC&color=fff'; }
        sinceEl.textContent = fmtDate(u.since);
      } else {
        avatar.src = 'https://ui-avatars.com/api/?name=Guest&size=128&background=334155&color=fff';
        sinceEl.textContent = '—';
      }

      const all = await loadAllLocations();
      const mine = (u && u.name) ? all.filter(r => (r?.name||'').toLowerCase() === u.name.toLowerCase()) : [];
      totalEl.textContent = String(mine.length);

      // Distinct locations: bucket by ~0.01 degrees (~1km)
      const buckets = new Set();
      for(const r of mine){
        if (r.latitude!=null && r.longitude!=null){
          const key = (Math.round(r.latitude*100)/100)+","+(Math.round(r.longitude*100)/100);
          buckets.add(key);
        }
      }
      locsEl.textContent = String(buckets.size);

      // Active days: from earliest of user.since or first catch
      const firstCatch = mine.reduce((min, r) => {
        const d = r.date ? new Date(r.date) : null;
        return d && (!min || d < min) ? d : min;
      }, null);
      const start = firstCatch || (u?.since ? new Date(u.since) : null);
      daysEl.textContent = start ? String(dayDiff(start, new Date())) : '0';

      // Recent list
      listEl.innerHTML = '';
      mine.sort((a,b)=> (new Date(b.date||0)) - (new Date(a.date||0)) ).slice(0,10).forEach(r => {
        const li = document.createElement('li');
        const where = (r.latitude!=null && r.longitude!=null) ? `${Number(r.latitude).toFixed(5)}, ${Number(r.longitude).toFixed(5)}` : '—';
        li.innerHTML = `<span>${fmtDate(r.date)}</span><span>${where}</span>`;
        listEl.appendChild(li);
      });
    })();
  </script>
</body>
</html>
