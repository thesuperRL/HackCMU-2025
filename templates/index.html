<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LanternFly Quest — HackCMU 2025</title>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- jQuery + PapaParse -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <!-- Site CSS (Flask static) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />

    <style>
      :root { --container-max: 1100px; }
      * { box-sizing: border-box; }

      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #111; }
      .container { max-width: var(--container-max); margin: 0 auto; padding: 0 16px; }

      /* Header */
      .site-header { border-bottom: 1px solid #eee; background: #fff; position: sticky; top: 0; z-index: 50; }
      .header-inner { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 14px 0; }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; }
      .brand .logo { width: 28px; height: 28px; color: #28a; }
      .pill { font-size: 12px; padding: 2px 6px; border: 1px solid #ddd; border-radius: 999px; color: #666; }

      .nav { display: flex; gap: 14px; }
      .nav a { text-decoration: none; color: #333; font-weight: 500; }
      .nav a:hover { color: #000; }

      .auth { display: flex; align-items: center; gap: 10px; }
      .hidden { display: none !important; }

      /* Hero */
      .hero { padding: 48px 0 8px; background: #f9fcff; border-bottom: 1px solid #eef5ff; }
      .hero-inner { display: grid; grid-template-columns: 1.2fr 1fr; gap: 24px; align-items: center; }
      .lead { color: #333; max-width: 50ch; }
      .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
      .btn.cta { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
      .btn.secondary { background: #f5f5f5; }
      .btn.small { padding: 6px 10px; font-size: 0.9rem; }

      .hero-card { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
      .card.stat { background: #fff; border: 1px solid #eee; border-radius: 14px; padding: 14px; display: grid; gap: 6px; }
      .card.stat i { font-size: 20px; color: #0ea5e9; }
      .stat-label { font-size: 12px; color: #666; }
      .stat-value { font-size: 20px; font-weight: 700; }

      /* Map section */
      .map-section { padding: 24px 0 48px; }
      .map-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; gap: 12px; }
      #map { width: 100%; height: 70vh; border-radius: 14px; overflow: hidden; border: 1px solid #e6e6e6; }

      /* Footer */
      .site-footer { border-top: 1px solid #eee; background: #fff; }
      .footer-inner { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }

      /* Error banner */
      .error-banner {
        position: fixed; left: 0; right: 0; top: 0; padding: 10px 14px;
        background: #fee; border-bottom: 1px solid #f99; color: #900;
        font: 14px/1.3 system-ui; z-index: 9999;
      }

      @media (max-width: 900px) {
        .hero-inner { grid-template-columns: 1fr; }
        #map { height: 60vh; }
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <svg class="logo" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M12 2c-2.5 0-4.5 2-4.5 4.5S12 14 12 14s4.5-5 4.5-7.5S14.5 2 12 2zm0 0c-3 0-5.5 2.5-5.5 5.5S9 13 12 13s5.5-2.5 5.5-5.5S15 2 12 2z"
              fill="currentColor"
            />
          </svg>
          <span class="title">LanternFly Quest</span>
          <span class="pill">alpha</span>
        </div>

        <nav class="nav">
          <a href="/">Home</a>
          <a href="/info">Info</a>
          <a href="/learn">Learn</a>
          <a href="/report">Report</a>
          <a href="/leaderboard">Leaderboard</a>
        </nav>

        <div class="auth">
          <div
            id="g_id_onload"
            data-auto_prompt="false"
            data-callback="handleCredentialResponse"
            data-client_id="598997653463-svi76fvbe15v910t9c91eulju4vqasaa.apps.googleusercontent.com"
          ></div>
          <div class="g_id_signin" data-theme="filled_blue" data-text="signup_with"></div>
          <div id="authed" class="authed hidden">
            <span id="whoami"></span>
            <button id="logoutBtn" class="btn secondary">Log out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main>
      <!-- Hero -->
      <section class="hero">
        <div class="container hero-inner">
          <div>
            <h1>Turn invasive pests into points.</h1>
            <p class="lead">
              Track, verify, and <strong>gamify</strong> the removal of spotted lanternflies.
              Log catches, compete on the leaderboard, and earn badges for real-world impact.
            </p>
            <a href="#report" class="btn cta">Start Reporting</a>
          </div>

          <div class="hero-card" aria-hidden="true">
            <div class="card stat">
              <i class="bi bi-trophy"></i>
              <span class="stat-label">Total Points</span>
              <span id="statTotalPoints" class="stat-value">0</span>
            </div>
            <div class="card stat">
              <i class="bi bi-fire"></i>
              <span class="stat-label">Your Streak</span>
              <span id="statStreak" class="stat-value">0</span>
            </div>
            <div class="card stat">
              <i class="bi bi-bug"></i>
              <span class="stat-label">Your Catches</span>
              <span id="statCatches" class="stat-value">0</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Map section -->
      <section class="map-section">
        <div class="container">
          <div class="map-header">
            <h2>Recent lanternfly reports</h2>
            <button id="recenter" class="btn small">Recenter to Pittsburgh</button>
          </div>
          <div id="map" role="region" aria-label="Lanternfly map"></div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
      <div class="container footer-inner">
        <span>LanternFly Quest · v0.1</span>
        <button id="resetDemo" class="btn danger small" title="Reset demo data">Reset</button>
      </div>
    </footer>

    <!-- Bootstrap bundle (optional for other UI) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Google Auth -->
    <script src="https://accounts.google.com/gsi/client" async></script>

    <!-- Your main JS (Flask static) -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- Map script -->
    <script>
      // Initialize map
      const map = L.map("map", {
        center: [40.44, -79.94], // Pittsburgh
        zoom: 9,
        scrollWheelZoom: true,
        tap: false,
      });

      // Basemap
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>',
      }).addTo(map);

      // Recenter button
      document.getElementById("recenter")?.addEventListener("click", () => {
        map.setView([40.44, -79.94], 9);
      });

      // ---------- CSV loading from Flask static ----------
      const CSV_URL = "{{ url_for('static', filename='data/lanternflydata.csv') }}";

      function showErrorBanner(msg) {
        const div = document.createElement("div");
        div.className = "error-banner";
        div.textContent = "Map data error: " + msg;
        document.body.appendChild(div);
      }

      function pickLatLngKeys(row) {
        const keys = Object.keys(row || {});
        const findOne = (cands) => keys.find(k => cands.includes(k.trim().toLowerCase()));
        const latKey = findOne(["latitude", "lat", "y"]);
        const lngKey = findOne(["longitude", "lon", "lng", "long", "x"]);
        return { latKey, lngKey };
      }

      const toNum = (v) => (typeof v === "number" ? v : (typeof v === "string" ? Number(v.trim()) : NaN));

      (async () => {
        try {
          const res = await fetch(CSV_URL, { cache: "no-cache" });
          if (!res.ok) throw new Error(`HTTP ${res.status} for ${CSV_URL}`);
          const text = await res.text();

          const parsed = Papa.parse(text, { header: true, dynamicTyping: true, skipEmptyLines: true });
          const rows = parsed.data || [];

          if (!rows.length) {
            showErrorBanner("CSV loaded but contains no rows.");
            return;
          }

          const { latKey, lngKey } = pickLatLngKeys(rows[0]);
          if (!latKey || !lngKey) {
            showErrorBanner("Could not find latitude/longitude columns in CSV. Expected headers like Latitude, Longitude (case-insensitive).");
            console.log("First row keys:", Object.keys(rows[0]));
            return;
          }

          const markers = [];
          for (const row of rows) {
            const lat = toNum(row[latKey]);
            const lng = toNum(row[lngKey]);
            if (!isFinite(lat) || !isFinite(lng)) continue;

            const nameKey = Object.keys(row).find(k => k.toLowerCase() === "name");
            const dateKey = Object.keys(row).find(k => k.toLowerCase() === "date");
            const imgKey  = Object.keys(row).find(k => k.toLowerCase() === "image");

            let html = "";
            if (nameKey && row[nameKey]) html += `<b>${row[nameKey]}</b><br/>`;
            if (dateKey && row[dateKey]) html += `<i>${row[dateKey]}</i><br/>`;
            if (imgKey  && row[imgKey])  html += `<img src="${row[imgKey]}" alt="${row[nameKey] || "image"}" width="140" />`;

            const m = L.marker([lat, lng], { opacity: 1 }).bindPopup(html || "Lanternfly report");
            m.addTo(map);
            markers.push(m);
          }

          if (markers.length === 0) {
            showErrorBanner("CSV loaded but no valid coordinates found. Check column names and values.");
          } else if (markers.length > 1) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.2));
          }
        } catch (err) {
          console.error(err);
          showErrorBanner(err.message + " (open DevTools → Network to inspect the request)");
        }
      })();
    </script>
  </body>
</html>
