<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LanternFly Quest â€” Leaderboard</title>

  <!-- Icons + App CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />

  <!-- Point to Flask static dir -->
  <link rel="stylesheet" href="../static/css/style.css" />

  <style>
    /* Page-specific tweaks (keeps your site CSS intact) */
    .page-header { padding: 32px 0 12px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .toolbar .input { flex:1; min-width:220px; }
    .input input {
      width:100%; background:var(--bg-elev); color:var(--fg);
      border:1px solid rgba(148,163,184,.22); border-radius:10px; padding:.65rem .8rem;
    }
    .input input:focus { border-color:transparent; box-shadow:0 0 0 6px var(--ring); outline:none; }

    .board { margin-top:16px; border-radius: var(--radius-xl); overflow: hidden; }
    table { width:100%; border-collapse: collapse; }
    thead th {
      text-align:left; font-weight:800; font-size:.95rem; color:var(--muted);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border-bottom:1px solid rgba(255,255,255,.08); padding:12px 14px; user-select:none; cursor:pointer;
    }
    tbody td { padding:14px; border-bottom:1px solid rgba(255,255,255,.06); }
    tbody tr:hover { background:rgba(255,255,255,.04); }
    .rank { font-weight:800; width:64px; }
    .user { display:flex; align-items:center; gap:10px; }
    .avatar {
      width:32px; height:32px; border-radius:999px; background:rgba(255,255,255,.08);
      display:inline-flex; align-items:center; justify-content:center; font-weight:800;
    }
    .badge { font-size:.75rem; padding:.15rem .45rem; border-radius:999px; background:rgba(125,211,252,.2); color:var(--fg); }
    .muted { color:var(--muted); font-size:.9rem; }
    .empty {
      text-align:center; padding:40px; color:var(--muted);
      border:1px dashed rgba(148,163,184,.35); border-radius: var(--radius-xl);
    }
    .sortable .arrow { opacity:.35; margin-left:6px; }
    .sortable.active.asc .arrow { transform: rotate(180deg); opacity:1; }
    .sortable.active.desc .arrow { opacity:1; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <svg class="logo" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2c-2.5 0-4.5 2-4.5 4.5S12 14 12 14s4.5-5 4.5-7.5S14.5 2 12 2zm0 0c-3 0-5.5 2.5-5.5 5.5S9 13 12 13s5.5-2.5 5.5-5.5S15 2 12 2z" fill="currentColor"/>
        </svg>
        <span class="title">LanternFly Quest</span>
        <span class="pill">alpha</span>
      </div>

      <nav class="nav">
        <a href="{{ url_for('index') }}#learn">Learn</a>
        <a href="{{ url_for('index') }}#report">Report</a>
        <a href="{{ url_for('leaderboard') }}" aria-current="page">Leaderboard</a>
      </nav>

      <div class="auth">
        <form id="loginForm" class="login-form" autocomplete="off">
          <input id="loginName" name="username" placeholder="Username" aria-label="Username" />
          <button type="submit" class="btn">Log in</button>
        </form>
        <div id="authed" class="authed hidden">
          <span id="whoami"></span>
          <button id="logoutBtn" class="btn secondary">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="page-header">
      <h1 style="margin:0 0 .35rem 0;">Leaderboard</h1>
      <p class="muted">Live rankings for verified lanternfly kills. Updates automatically.</p>
    </section>

    <div class="toolbar">
      <div class="input">
        <input id="searchInput" type="text" placeholder="Search usersâ€¦" />
      </div>
      <button id="refreshBtn" class="btn secondary"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
      <button id="seedBtn" class="btn small"><i class="bi bi-beaker"></i> Seed Demo</button>
      <span class="muted" id="lastSync" aria-live="polite"></span>
    </div>

    <div class="panel board" role="region" aria-label="Leaderboard table">
      <table id="leaderboardTable">
        <thead>
          <tr>
            <th class="sortable" data-key="rank">Rank <i class="bi bi-caret-down-fill arrow"></i></th>
            <th>User</th>
            <th class="sortable" data-key="catches">Catches <i class="bi bi-caret-down-fill arrow"></i></th>
            <th class="sortable" data-key="points">Points <i class="bi bi-caret-down-fill arrow"></i></th>
            <th class="sortable" data-key="streak">Streak <i class="bi bi-caret-down-fill arrow"></i></th>
            <th class="sortable" data-key="updatedAt">Last Updated <i class="bi bi-caret-down-fill arrow"></i></th>
          </tr>
        </thead>
        <tbody id="leaderboardBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
      <div id="emptyState" class="empty" hidden>
        <i class="bi bi-emoji-neutral"></i> No scores yet. Report a catch to get on the board!
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <span>LanternFly Quest Â· v0.1</span>
      <button id="resetDemo" class="btn danger small" title="Reset demo data">Reset</button>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const STORAGE_KEY = 'lfq:scores';

    // -------- utilities --------
    const nowIso = () => new Date().toISOString();
    const fmtTimeAgo = (iso) => {
      if (!iso) return 'â€”';
      const diff = Date.now() - new Date(iso).getTime();
      const s = Math.floor(diff / 1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h}h ago`;
      const d = Math.floor(h/24);
      return `${d}d ago`;
    };

    function getScores() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
      } catch {
        return {};
      }
    }
    function setScores(obj) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
      dispatchEvent(new Event('lfq:scores-updated'));
    }

    // Public helper so other pages can update scores
    window.LFQ = window.LFQ || {};
    /**
     * Add/Update a user's catch.
     * @param {string} username
     * @param {number} pointsDelta
     * @param {object} extra {avatar?:string, streakDelta?:number, catchesDelta?:number}
     */
    window.LFQ.addKill = function(username, pointsDelta=5, extra={}) {
      const scores = getScores();
      const u = scores[username] || { points:0, catches:0, streak:0, updatedAt:null, avatar: extra.avatar || null };
      u.points += pointsDelta;
      u.catches += (extra.catchesDelta ?? 1);
      u.streak  += (extra.streakDelta ?? 1);
      u.updatedAt = nowIso();
      if (extra.avatar && !u.avatar) u.avatar = extra.avatar;
      scores[username] = u;
      setScores(scores);
    };

    // -------- rendering --------
    const bodyEl = document.getElementById('leaderboardBody');
    const emptyEl = document.getElementById('emptyState');
    const lastSyncEl = document.getElementById('lastSync');
    const searchEl = document.getElementById('searchInput');

    const sortState = { key: 'points', dir: 'desc' }; // default sort
    const sortableHeaders = Array.from(document.querySelectorAll('th.sortable'));

    function computeRows(filterTerm='') {
      const data = getScores();
      const rows = Object.entries(data).map(([username, v]) => ({
        username,
        ...v
      }));

      const term = filterTerm.trim().toLowerCase();
      const filtered = term
        ? rows.filter(r => r.username.toLowerCase().includes(term))
        : rows;

      // sort
      const dirFactor = sortState.dir === 'asc' ? 1 : -1;
      filtered.sort((a,b) => {
        const k = sortState.key;
        if (k === 'updatedAt') {
          const av = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
          const bv = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
          return (av - bv) * dirFactor;
        }
        if (k === 'rank') {
          // computed after sorting by points; keep stable
          return 0;
        }
        const av = a[k] ?? 0;
        const bv = b[k] ?? 0;
        if (av === bv) return a.username.localeCompare(b.username) * dirFactor;
        return (av - bv) * dirFactor;
      });

      // assign rank by points (desc) then catches, then streak
      const byScore = [...filtered].sort((a,b)=>{
        if (a.points !== b.points) return b.points - a.points;
        if (a.catches !== b.catches) return b.catches - a.catches;
        if (a.streak !== b.streak) return b.streak - a.streak;
        return a.username.localeCompare(b.username);
      });
      const rankMap = new Map(byScore.map((r, i) => [r.username, i+1]));
      filtered.forEach(r => r.rank = rankMap.get(r.username));

      return filtered;
    }

    function render() {
      const rows = computeRows(searchEl.value);
      bodyEl.innerHTML = '';

      if (rows.length === 0) {
        emptyEl.hidden = false;
      } else {
        emptyEl.hidden = true;
        for (const r of rows) {
          const tr = document.createElement('tr');

          const tdRank = document.createElement('td');
          tdRank.className = 'rank';
          tdRank.textContent = r.rank ?? 'â€”';

          const tdUser = document.createElement('td');
          tdUser.className = 'user';
          const avatar = document.createElement('span');
          avatar.className = 'avatar';
          avatar.textContent = (r.username[0] || '?').toUpperCase();
          if (r.avatar) {
            avatar.style.backgroundImage = `url('${r.avatar}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.textContent = '';
          }
          const uname = document.createElement('strong');
          uname.textContent = r.username;
          tdUser.append(avatar, uname);

          const tdC = document.createElement('td');
          tdC.textContent = r.catches ?? 0;

          const tdP = document.createElement('td');
          tdP.innerHTML = `<strong>${r.points ?? 0}</strong>`;

          const tdS = document.createElement('td');
          tdS.innerHTML = `${r.streak ?? 0} <span class="badge">ðŸ”¥</span>`;

          const tdU = document.createElement('td');
          tdU.className = 'muted';
          tdU.textContent = fmtTimeAgo(r.updatedAt);

          tr.append(tdRank, tdUser, tdC, tdP, tdS, tdU);
          bodyEl.appendChild(tr);
        }
      }

      lastSyncEl.textContent = `Last sync: ${new Date().toLocaleTimeString()}`;
      // update header active state
      sortableHeaders.forEach(th => {
        th.classList.remove('active','asc','desc');
        if (th.dataset.key === sortState.key) {
          th.classList.add('active', sortState.dir);
        }
      });
    }

    // -------- events & live updates --------
    // sort handlers
    sortableHeaders.forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        if (sortState.key === key) {
          sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.key = key;
          sortState.dir = key === 'updatedAt' ? 'desc' : 'desc';
        }
        render();
      });
    });

    // search
    searchEl.addEventListener('input', () => render());

    // refresh button
    document.getElementById('refreshBtn').addEventListener('click', render);

    // seed demo data
    document.getElementById('seedBtn').addEventListener('click', () => {
      const demo = {
        rishay: { points: 42, catches: 9, streak: 3, updatedAt: nowIso(), avatar: "https://i.pravatar.cc/64?u=rishay" },
        alex:   { points: 28, catches: 6, streak: 2, updatedAt: nowIso(), avatar: "https://i.pravatar.cc/64?u=alex" },
        maya:   { points: 66, catches: 13, streak: 5, updatedAt: nowIso(), avatar: "https://i.pravatar.cc/64?u=maya" }
      };
      setScores(demo);
      render();
    });

    // allow other tabs/pages to update in real time
    window.addEventListener('storage', (e) => {
      if (e.key === STORAGE_KEY) render();
    });
    window.addEventListener('lfq:scores-updated', render);

    // periodic auto-refresh (in case something external updates storage)
    setInterval(render, 5000);

    // reset demo (reuse your footer button)
    document.getElementById('resetDemo').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      render();
    });

    // initial render
    render();
  </script>
</body>
</html>