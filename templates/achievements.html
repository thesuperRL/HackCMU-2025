<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Achievements · LanternFly Quest</title>

  <!-- Icons & theme -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />

  <!-- Page-scoped styles -->
  <style>
    .achv-badge {
      width: 47px;
      height: 47px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: rgba(14, 165, 233, .15);
      border: 1px solid rgba(14, 165, 233, .35);
    }


    .achv-hero {
      padding: 48px 0 16px;
      background: radial-gradient(1200px 400px at 30% -10%, rgba(14, 165, 233, .20), transparent 60%),
        radial-gradient(800px 320px at 85% -5%, rgba(99, 102, 241, .14), transparent 60%);
      border-bottom: 1px solid rgba(255, 255, 255, .06);
    }

    .achv-summary {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: end;
      margin-bottom: 8px;
    }

    .achv-kicker {
      color: var(--muted);
      margin: 0
    }

    .achv-total {
      font-weight: 800;
      font-size: 1.5rem;
      margin: 0
    }

    /* Center the last row nicely on any screen size */
    .achv-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      justify-content: center;
      /* centers the final row */
      align-items: stretch;
    }

    @media (max-width: 520px) {
      .achv-grid {
        grid-template-columns: 1fr;
      }
    }

    .achv-card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .07), rgba(255, 255, 255, .02));
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: var(--radius-xl, 20px);
      padding: 16px;
      box-shadow: var(--shadow, 0 10px 30px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .03));
      display: grid;
      gap: 10px;
      transition: filter .25s ease, box-shadow .25s ease, border-color .25s ease;
    }
    .achv-card[data-earned="1"]{
      filter: brightness(1.15);
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 12px 36px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* --- Achievement toast popup --- */
    .toast-container{ position: fixed; right: 16px; bottom: 16px; z-index: 4000; display: grid; gap: 8px; }
    .toast{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px; padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      animation: toast-in .25s ease;
    }
    .toast img{ width: 28px; height: 28px; object-fit: cover; border-radius: 8px; }
    .toast strong{ font-weight: 800; }
    @keyframes toast-in{ from{ opacity:0; transform: translateY(8px);} to{ opacity:1; transform: translateY(0);} }
    @media (max-width: 600px){
      .toast-container{ right: auto; left: 50%; transform: translateX(-50%); bottom: max(16px, env(safe-area-inset-bottom)); }
      .toast{ max-width: 92vw; }
    }

    .achv-head {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .achv-badge img {
      width: 40px;
      /* fixed size */
      height: 40px;
      /* fixed size */
      object-fit: contain;
      display: block;
    }

    .achv-title {
      font-weight: 800;
      margin: 0;
    }

    .achv-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 800;
      font-size: .85rem;
      border: 1px solid rgba(255, 255, 255, .10);
    }

    .achv-earned {
      background: rgba(34, 197, 94, .15);
      color: #86efac;
      border-color: rgba(34, 197, 94, .35);
    }

    .achv-locked {
      background: rgba(15, 23, 42, .55);
      color: var(--muted);
    }

    .achv-desc {
      color: var(--muted);
      margin: 0;
    }

    .achv-progress {
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .08);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .1);
    }

    .achv-progress>div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #34d399, #0ea5e9);
      transition: width .4s ease;
    }

    .achv-req {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .92rem;
      color: var(--muted);
    }

    .achv-req strong {
      color: var(--fg);
    }

    /* Profile dropdown (consistent across pages) */
    .auth {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .profile {
      position: relative;
      margin-left: .25rem;
    }

    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .22);
      background: var(--bg-elev, #0f152a);
      color: var(--fg, #eef2ff);
      cursor: pointer;
      transition: filter .15s ease, transform .08s ease;
    }

    .icon-btn:hover {
      filter: brightness(1.1);
    }

    .icon-btn:active {
      transform: translateY(1px);
    }

    .icon-btn img {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      object-fit: cover;
      display: block;
    }

    .dropdown {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      z-index: 1000;
      min-width: 260px;
      background: var(--bg-elev, #0f152a);
      color: var(--fg, #eef2ff);
      border: 1px solid rgba(148, 163, 184, .18);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35), inset 0 1px 0 rgba(255, 255, 255, .03);
      padding: 8px;
    }

    .dropdown.hidden {
      display: none;
    }

    .dropdown-header {
      padding: 8px 10px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, .18);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .dropdown-header small {
      color: var(--muted, #9aa4c7);
      font-weight: 600;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: rgba(255, 255, 255, .06);
    }

    .dropdown-item.btn-danger {
      color: #fff;
      background: linear-gradient(180deg, var(--danger, #f87171), #b91c1c);
    }

    .rule {
      height: 1px;
      background: rgba(148, 163, 184, .18);
      margin: 8px 0;
    }
  </style>
</head>

<body>

  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="/" aria-label="Home">
        <svg class="logo" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M12 2c-2.5 0-4.5 2-4.5 4.5S12 14 12 14s4.5-5 4.5-7.5S14.5 2 12 2zm0 0c-3 0-5.5 2.5-5.5 5.5S9 13 12 13s5.5-2.5 5.5-5.5S15 2 12 2z"
            fill="currentColor" />
        </svg>
        <span class="title">LanternFly Quest</span>
        <span class="pill">alpha</span>
      </a>

      <nav class="nav">
        <a href="/">Home</a>
        <a href="/info">About</a>
        <a href="/learn">Learn</a>
        <a href="/report">Report</a>
        <a href="/leaderboard">Leaderboard</a>
      </nav>

      <div class="auth">
        <div class="profile">
          <button id="profileBtn" class="icon-btn" aria-haspopup="menu" aria-expanded="false" title="Account">
            <i class="bi bi-person-circle" aria-hidden="true"></i>
          </button>

          <div id="profileMenu" class="dropdown hidden" role="menu" aria-label="Account menu">
            <div class="dropdown-header">
              <div id="ddName">Guest</div>
              <small id="ddEmail">Not signed in</small>
            </div>

            <!-- Google Sign-In slot (rendered on first open) -->
            <div id="gisBlock" class="dropdown-item" style="justify-content:center;">
              <div id="gisBtn"></div>
            </div>

            <div class="rule"></div>
            <a class="dropdown-item" href="/profile"><i class="bi bi-person"></i> Profile</a>
            <a class="dropdown-item" href="/achievements"><i class="bi bi-award"></i> Achievements</a>

            <div class="rule"></div>
            <button id="logoutMenuBtn" class="dropdown-item btn-danger" type="button">
              <i class="bi bi-box-arrow-right"></i> Log out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="achv-hero">
    <div class="container">
      <h1 style="margin:0 0 6px 0;">Achievements</h1>
      <p class="achv-kicker">Earn badges as you help control spotted lanternflies.</p>
    </div>
  </section>

  <!-- Achievements grid -->
  <main class="section">
    <div class="container">
      <div class="achv-summary" style="grid-template-columns: 1fr auto; align-items: end; gap: 12px;">
        <p class="achv-kicker">Your total catches</p>
        <p class="achv-total"><span id="achvCatches">0</span> <span
            style="color:var(--muted);font-weight:600;">flies</span></p>
      </div>

      <div id="achievements" class="achv-grid" aria-live="polite"></div>
    </div>
  </main>

  <!-- Toasts -->
  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <span>LanternFly Quest · v0.1</span>
    </div>

  </footer>

  <!-- Optional: Bootstrap & Google Identity -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async></script>
  <script src="{{ url_for('static', filename='js/main.js') }}?v=3"></script>

  <script>
    /* -------------------------
       Core achievements (global)
    ------------------------- */
    const BASE_ACHIEVEMENTS = [
      { id: 'first-blood', title: 'First Blood', req: 1, icon: 'firstBlood.png', color: '#34d399' },
      { id: 'tenacious', title: 'Tenacious Ten', req: 10, icon: 'tenacious.png', color: '#f59e0b' },
      { id: 'field-agent', title: 'Field Agent', req: 25, icon: 'fieldAgent.png', color: '#7dd3fc' },
      { id: 'neighborhood', title: 'Hometown Hero', req: 50, icon: 'hometownHero.png', color: '#a78bfa' },
      { id: 'centurion', title: 'Centurion', req: 100, icon: 'centurion.png', color: '#ef4444' },
      { id: 'ranger', title: 'Urban Ranger', req: 250, icon: 'urbanRanger.png', color: '#10b981' },
      { id: 'exterminator', title: 'Exterminator', req: 500, icon: 'exterminator.png', color: '#22d3ee' },
      { id: 'legend', title: 'Pitt Legend', req: 1000, icon: 'pittLegend.png', color: '#fde047' },
    ];


    /* ---------------------------------------------------
       Geo achievements (cities & states) — examples
       Provide counts via localStorage or query params.
       LocalStorage keys:
         - LFQ_BY_CITY  = {"Pittsburgh": 6, "Philadelphia": 3}
         - LFQ_BY_STATE = {"PA": 15, "NJ": 8, "NY": 2}
       Or via URL params like:
         ?city.Pittsburgh=6&city.Philadelphia=3&state.PA=15
    --------------------------------------------------- */
    const CITY_TARGETS = [
      { name: 'Pittsburgh', req: 5, icon: 'pittsburgh.png', color: '#38bdf8' },
      { name: 'Philly', req: 5, icon: 'philly.png', color: '#60a5fa' },
      { name: 'New York', req: 5, icon: 'newYork.png', color: '#22d3ee' },
      { name: 'Newark', req: 3, icon: 'newark.png', color: '#67e8f9' },
    ];

    const STATE_TARGETS = [
      { abbr: 'PA', name: 'PA', req: 10, icon: 'PA.png', color: '#34d399' },
      { abbr: 'NJ', name: 'NJ', req: 10, icon: 'NJ.png', color: '#f59e0b' },
      { abbr: 'NY', name: 'NY', req: 10, icon: 'NY.png', color: '#ef4444' },
      { abbr: 'DE', name: 'DE', req: 5, icon: 'DE.png', color: '#a78bfa' },
    ];

    // Test JSON-style data for places and their captured counts
    // Use this for demos or local testing (does not affect backend data)
    const TEST_COUNTS_BY_PLACE = {
      // Cities
      "Pittsburgh": 6,
      "Philly": 0,
      "New York": 0,
      "Newark": 0,
      // States
      "PA": 6,
      "NJ": 0,
      "NY": 0,
      "DE": 0
    };
    // Optional: provide a separate total that is NOT the sum of places.
    // Set to a number to override. If null, we will fall back to getCatches() or the sum of TEST_COUNTS_BY_PLACE.
    const TEST_TOTAL_CATCHES = 6;


    /* -------------------------
       Read totals & geo splits
    ------------------------- */
    function getCatchesFromURL() {
      const m = location.search.match(/[?&]catches=(\d+)/i);
      return m ? parseInt(m[1], 10) : null;
    }
    function getCatchesFromLocalStorage() {
      const keys = ['LFQ_CATCHES', 'catches', 'demo.catches'];
      for (const k of keys) {
        const v = localStorage.getItem(k);
        if (v != null && !isNaN(Number(v))) return Number(v);
      }
      return null;
    }
    function getCatchesFromApp() {
      try {
        const v = window.App?.stats?.catches ?? window.App?.user?.catches;
        if (v != null && !isNaN(Number(v))) return Number(v);
      } catch (_) { }
      return null;
    }
    function getCatches() {
      return getCatchesFromApp()
        ?? getCatchesFromLocalStorage()
        ?? getCatchesFromURL()
        ?? 0;
    }

    function parseObjFromLocalStorage(key) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }
    function parseGeoFromURL(prefix) {
      // ?city.Pittsburgh=6&state.PA=15
      const params = new URLSearchParams(location.search);
      const out = {};
      for (const [k, v] of params) {
        if (k.startsWith(prefix + ".")) {
          out[k.slice(prefix.length + 1)] = Number(v);
        }
      }
      return out;
    }

    const BY_CITY = Object.assign({}, parseObjFromLocalStorage('LFQ_BY_CITY'), parseGeoFromURL('city'));
    const BY_STATE = Object.assign({}, parseObjFromLocalStorage('LFQ_BY_STATE'), parseGeoFromURL('state'));

    /* ---------------------------------------
       Build geo achievements with progress
    --------------------------------------- */
    function buildCityAchievements() {
      return CITY_TARGETS.map(c => ({
        id: `city-${c.name.toLowerCase().replace(/\s+/g, '-')}`,
        title: `${c.name} Patrol`,
        req: c.req,
        icon: c.icon,
        color: c.color,
        desc: `Catch ${c.req} in ${c.name}.`,
        progress: Number(BY_CITY[c.name] || 0)
      }));
    }
    function buildStateAchievements() {
      return STATE_TARGETS.map(s => ({
        id: `state-${s.abbr.toLowerCase()}`,
        title: `${s.name} Defender`,
        req: s.req,
        icon: s.icon,
        color: s.color,
        desc: `Catch ${s.req} across ${s.name}.`,
        progress: Number(BY_STATE[s.abbr] || 0)
      }));
    }

    /* -------------------------
       Render helpers
    ------------------------- */
    function makeCard(a, totalCatches) {
      // If a.progress is provided (city/state), use it; else use total
      const progress = (typeof a.progress === 'number') ? a.progress : totalCatches;
      const earned = progress >= a.req;
      const pct = Math.max(0, Math.min(100, Math.floor((progress / a.req) * 100)));

      const card = document.createElement('div');
      card.className = 'achv-card';
      card.setAttribute('data-earned', earned ? '1' : '0');

      const desc = a.desc || `Catch ${a.req.toLocaleString()} lanternfl${a.req === 1 ? 'y' : 'ies'}.`;

      card.innerHTML = `
<div class="achv-head">
  <div class="achv-badge" 
       style="background: linear-gradient(180deg, ${a.color}33, ${a.color}22); border-color: ${a.color}66">
    <img src="{{ url_for('static', filename='data/achievementPics/') }}${a.icon}" 
         alt="${a.title} badge">
  </div>

          <div>
            <h3 class="achv-title">${a.title}</h3>
            <p class="achv-desc">${desc}</p>
          </div>
          <span class="achv-status ${earned ? 'achv-earned' : 'achv-locked'}">
            ${earned ? '<i class="bi bi-check-circle"></i> Earned' : '<i class="bi bi-lock"></i> Locked'}
          </span>
        </div>

        <div class="achv-progress" aria-hidden="true"><div style="width:${pct}%"></div></div>

        <div class="achv-req">
          <span>Progress</span>
          <span><strong>${Math.min(progress, a.req).toLocaleString()}</strong> / ${a.req.toLocaleString()}</span>
        </div>
      `;
      return card;
    }

    /* -------------------------
       Bootstrap render
    ------------------------- */
    // Use TEST_COUNTS_BY_PLACE to drive progress
    (function renderFromTestCounts(){
      const sumCounts = (obj)=> Object.values(obj||{}).reduce((acc,v)=> acc + (isFinite(Number(v))?Number(v):0), 0);
      const place = (name)=> Number((TEST_COUNTS_BY_PLACE||{})[name] || 0);

      // Total catches: prefer explicit TEST_TOTAL_CATCHES, then any existing getCatches(), else sum of known places
      let total = null;
      if (typeof TEST_TOTAL_CATCHES === 'number' && isFinite(TEST_TOTAL_CATCHES)) total = TEST_TOTAL_CATCHES;
      else if (typeof getCatches === 'function') { try { total = Number(getCatches()||0) || 0; } catch { total = null; } }
      if (total == null) total = sumCounts(TEST_COUNTS_BY_PLACE||{});
      const totalEl = document.getElementById('achvCatches');
      if (totalEl) totalEl.textContent = total.toLocaleString();

      const cityAch = CITY_TARGETS.map(c=>({
        id: `city-${c.name.toLowerCase().replace(/\s+/g,'-')}`,
        title: `${c.name} Patrol`,
        req: c.req,
        icon: c.icon,
        color: c.color,
        desc: `Catch ${c.req} in ${c.name}.`,
        progress: place(c.name)
      }));
      const stateAch = STATE_TARGETS.map(s=>({
        id: `state-${s.abbr.toLowerCase()}`,
        title: `${s.name} Defender`,
        req: s.req,
        icon: s.icon,
        color: s.color,
        desc: `Catch ${s.req} across ${s.name}.`,
        progress: place(s.abbr)
      }));

      const achievements = [ ...BASE_ACHIEVEMENTS, ...cityAch, ...stateAch ];
      achievements.sort((a,b)=> a.req - b.req);
      const grid = document.getElementById('achievements');
      grid.innerHTML = '';
      achievements.forEach(a => grid.appendChild(makeCard(a, total)));

      // --- Popups for newly unlocked achievements ---
      const earnedNow = achievements.filter(a => (typeof a.progress === 'number' ? a.progress : total) >= a.req).map(a => a.id);
      let earnedPrev = [];
      try { earnedPrev = JSON.parse(localStorage.getItem('achv.earnedPrev') || '[]'); if(!Array.isArray(earnedPrev)) earnedPrev = []; } catch { earnedPrev = []; }
      const newlyUnlocked = earnedNow.filter(id => !earnedPrev.includes(id));
      try { localStorage.setItem('achv.earnedPrev', JSON.stringify(earnedNow)); } catch {}

      if (newlyUnlocked.length) {
        const byId = {}; achievements.forEach(a => byId[a.id] = a);
        const queue = newlyUnlocked.map(id => byId[id]).filter(Boolean);
        const container = document.getElementById('toastContainer');
        function showNext(){
          const a = queue.shift(); if(!a) return;
          const srcBase = "{{ url_for('static', filename='data/achievementPics/') }}";
          const imgFile = a.icon || 'image-removebg-preview.png';
          const node = document.createElement('div');
          node.className = 'toast';
          node.innerHTML = `<img src="${srcBase}${imgFile}" alt="${a.title}"><div><div style="font-size:.8rem;color:var(--muted)">Achievement Unlocked</div><strong>${a.title}</strong></div>`;
          container.appendChild(node);
          setTimeout(()=>{ node.remove(); showNext(); }, 2600);
        }
        showNext();
      }
    })();
  </script>

  <!-- Initialize Google Identity for programmatic button rendering -->
  <div id="g_id_onload" data-auto_prompt="false"
    data-client_id="598997653463-svi76fvbe15v910t9c91eulju4vqasaa.apps.googleusercontent.com"
    data-callback="handleCredentialResponse">
  </div>
</body>

</html>
